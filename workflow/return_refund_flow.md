# Return & Refund Flow

**Last Updated**: 2026-01-18
**Status**: Verified vs Code

## Overview

This document describes the business logic for handling customer returns and exchanges. The entire flow is managed within the `order` service, which orchestrates calls to other services like `shipping`, `payment`, and `warehouse`.

**Key File**: `order/internal/biz/return/return.go`

---

## Key Flows

### 1. Return/Exchange Request Creation

- **File**: `return.go` (`CreateReturnRequest`)
- **Logic**:
  1.  **Eligibility Check**: The system first validates if a return is allowed:
      - The order must belong to the customer.
      - The order status must be `delivered`.
      - The request must be within the return window (e.g., 30 days from `order.CompletedAt`).
  2.  **Request Creation**: A `ReturnRequest` record is created in the database with a `pending` status.
  3.  **Event Publishing**: An event (`return.requested` or `exchange.requested`) is published to notify other systems.

### 2. Status Update and Side Effects

- **File**: `return.go` (`UpdateReturnRequestStatus`)
- **Logic**: This function acts as a state machine for the return process. Key transitions trigger side effects:
  -   **On `approved`**:
      -   A return shipping label is automatically generated by calling the `shipping` service.
      -   If the request is for an exchange, the `processExchangeOrder` logic is triggered.
  -   **On `completed`**:
      -   The `processReturnRefund` function is called to initiate a refund via the `payment` service.
      -   The `restockReturnedItems` function is called to return items to inventory via the `warehouse` service.

### 3. Refund Processing

- **File**: `return.go` (`processReturnRefund`)
- **Logic**:
  1.  Finds the original `paymentID` associated with the order.
  2.  Calls `paymentService.ProcessRefund` with the calculated refund amount.
  3.  Updates the `ReturnRequest` with the `RefundID` from the payment service.

### 4. Item Restocking

- **File**: `return.go` (`restockReturnedItems`)
- **Logic**:
  1.  Iterates through the returned items.
  2.  For each item marked as `Restockable`, it calls `warehouseService.RestockItem`.

---

## Identified Issues & Gaps

Based on the `AI-OPTIMIZED CODE REVIEW GUIDE`.

### P1 - Resilience: Best-Effort Refund/Restock

- **Description**: When a return is `completed`, the refund and restock operations are handled in a "best-effort" or "fire-and-forget" manner. If `processReturnRefund` or `restockReturnedItems` fails, the error is logged, but the `ReturnRequest` status remains `completed`.
- **Impact**: This can lead to critical data inconsistencies. A customer's return could be marked as complete, but they might not receive their refund, or the inventory might not be updated correctly.
- **Recommendation**: Introduce more granular statuses for the return flow (e.g., `pending_refund`, `refund_failed`, `pending_restock`). Failures should move the request into a failed state and be pushed to a DLQ for retry or manual intervention, rather than being silently logged.

### P1 - Idempotency: Refund Calls are Not Idempotent

- **Description**: The `processReturnRefund` function calls `paymentService.ProcessRefund` without providing an idempotency key. The `payment` service's refund endpoint itself also lacks API-level idempotency.
- **Impact**: If a `completed` status update is retried, it could trigger a second refund, leading to financial loss.
- **Recommendation**: The `order` service must generate and pass a unique idempotency key (e.g., based on the `ReturnRequest` ID) when calling `paymentService.ProcessRefund`. The `payment` service must be updated to honor this key.

### P1 - Correctness: Hardcoded Fallback Values

- **Description**: The `generateReturnShippingLabel` function contains hardcoded fallback values for the warehouse address (a location in San Francisco, US) and for item weight (0.5 kg).
- **Impact**: This will lead to incorrect shipping labels and costs if the primary data sources (warehouse service, product catalog) fail or are unavailable.
- **Recommendation**: Remove hardcoded fallbacks. If a reliable address or weight cannot be determined, the function should fail fast and return an error, preventing the generation of an incorrect label.
